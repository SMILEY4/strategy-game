AWSTemplateFormatVersion: "2010-09-09"

Parameters:
    InstanceName:
        Type: "String"
        Description: "Name of the ec2-instance"
        Default: "swarm-master"
    InstanceKeyPairName:
        Type: "String"
        Description: "Name of a key-pair for ec2-instances"
        Default: "ec2-kp"
    InstanceType:
        Type: "String"
        Description: "Type of the ec2-instance"
        Default: "t2.micro"
    ImageId:
        Type: "String"
        Description: "Type of the image. Use Ubuntu or change the username in the UserData-Script of the ec2 instance."
        Default: "ami-0ec7f9846da6b0f61"
    InstanceProfile:
        Type: String
        Description: "The name of the (master) instance-profile."
        Default: "ec2-swarm-master"
    SecurityGroup:
        Type: String
        Description: "The name/id of the (master) security-group."
        Default: "ec2-swarm"

Resources:

    Instance:
        Type: "AWS::EC2::Instance"
        Properties:
            Tags:
                - Key: "Name"
                  Value: !Ref InstanceName
            ImageId: !Ref ImageId
            InstanceType: !Ref InstanceType
            IamInstanceProfile: !Ref InstanceProfile
            KeyName: !Ref InstanceKeyPairName
            SecurityGroupIds:
                - !Ref SecurityGroup
            UserData:
                Fn::Base64: |
                    #!/bin/bash -xe

                    echo "setting up instance as swarm-master..."

                    sudo apt-get update
                    
                    echo "installing aws-cli..."
                    sudo apt-get install awscli -y

                    echo "installing python..."
                    sudo apt install python3 -y

                    echo "installing unzip..."
                    sudo apt install unzip -y

                    echo "installing docker..."
                    sudo apt install docker.io -y
                    sudo usermod -aG docker ubuntu
                    newgrp docker
                    docker swarm init
                    
                    echo "installing amazon-ecr-credential-helper..."
                    sudo apt install amazon-ecr-credential-helper
                    sudo -u ubuntu mkdir /home/ubuntu/.docker
                    echo "{\"credsStore\":\"ecr-login\"}" >> /home/ubuntu/.docker/config.json
                    
                    echo "setting up application..."
                    sudo -u ubuntu mkdir /home/ubuntu/app
                    aws s3 cp s3://strategy-game.swarm/setup.py /home/ubuntu/app/setup.py
                    aws s3 cp s3://strategy-game.swarm/deploy.py /home/ubuntu/app/deploy.py
                    sudo chown ubuntu /home/ubuntu/app/setup.py
                    sudo chown ubuntu /home/ubuntu/app/deploy.py
                    python3 /home/ubuntu/app/setup.py

                    echo "...Setup of swarm-master complete"
